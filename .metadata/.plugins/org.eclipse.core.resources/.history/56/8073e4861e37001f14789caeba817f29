#include "buzzer.h"

void Buzzer_Init(BuzzerTypeDef *buzzer) {
    Buzzer_SetFrequency(buzzer, buzzer->frequency);
    Buzzer_SetVolume(buzzer, buzzer->volume);

    uint32_t period=0;
    if (buzzer->htim->Instance == TIM1 ) {
//    if (buzzer->htim->Instance == TIM1 || buzzer->htim->Instance == TIM8) {
    	 period = HAL_RCC_GetPCLK2Freq()/1000000-1;
    } else {
    	 period = HAL_RCC_GetPCLK1Freq()/1000000-1;
    }
    __HAL_TIM_SET_AUTORELOAD(buzzer->htim, period);

    HAL_TIM_PWM_Start(buzzer->htim, buzzer->channel);
}

void Buzzer_SetFrequency(BuzzerTypeDef *buzzer, uint32_t frequency) {
    buzzer->frequency = frequency;

    uint32_t prescaler = 1000000/frequency  - 1;
    __HAL_TIM_SET_PRESCALER(buzzer->htim, prescaler);
}

void Buzzer_SetVolume(BuzzerTypeDef *buzzer, uint8_t volume) {
    buzzer->volume = volume;
    uint32_t compare_value = volume;

    __HAL_TIM_SET_COMPARE(buzzer->htim, buzzer->channel, compare_value);
}


void playMelody(BuzzerTypeDef *buzzer) {
    Note melody[] = {
//    		{698,355},{20,23},{1047,355},{20,23},{932,355},{20,23},{587,729},{20,23},
//			{932,167},{20,23},{1047,167},{20,23},{1175,167},{20,23},{1047,167},{20,23},
//			{932,167},{20,23},{1047,167},{20,23},{698,355},{20,23},{1047,355},{20,23},
//			{932,355},{20,23},{587,729},{20,23},{932,167},{20,23},{1047,167},{20,23},
//			{1175,167},{20,23},{1047,167},{20,23},{932,167},{20,23},{1047,167},{20,23},
//			{698,355},{20,23},{1047,355},{20,23},{932,355},{20,23},{698,729},{20,23},{932,167},
//			{20,23},{1047,167},{20,23},{1175,167},{20,23},{1047,167},{20,23},{932,167},{20,23},
//			{1047,167},{20,23},{698,355},{20,23},{1047,355},{20,23},{932,355},{20,23},{698,729},
//			{20,23},{466,355},{20,23},{587,355},{20,23},{698,355},{20,23},{784,1105},{20,23},
//			{698,1667},{20,23},{466,167},{20,23},{523,355},{20,23},{523,355},{20,23},{466,355},
//			{20,23},{587,1479},{20,23},{587,167},{20,23},{698,167},{20,23},{784,355},{20,23},
//			{880,355},{20,23},{784,355},{20,23},{698,355},{20,23},{587,355},{20,23},{523,355},
//			{20,23},{523,355},{20,23},{466,355},{20,23},{523,355},{20,23},{523,355},{20,23},
//			{587,355},{20,23},{466,1125},{20,100},{20,94},{523,167},{20,23},{587,167},{20,23},
//			{698,167},{20,23},{784,1105},{20,23},{698,1667},{20,23},{466,167},{20,23},{523,355},
//			{20,23},{523,355},{20,23},{466,355},{20,23},{587,1105},{20,23},{587,355},{20,23},
//			{698,355},{20,23},{784,355},{20,23},{932,355},{20,23},{1047,355},{20,23},{1175,355},
//			{20,23},{1047,355},{20,23},{932,355},{20,23},{784,355},{20,23},{932,355},{20,23},
//			{1047,355},{20,23},{1047,355},{20,23},{932,355},{20,23},{932,1105},{20,23},{784,355},
//			{20,23},{932,355},{20,23},{1047,355},{20,23},{1047,355},{20,23},{932,355},{20,23},
//			{932,1875},{20,100},{370,542},{20,23},{330,167},{20,23},{370,542},{20,23},{330,167},
//			{20,23},{370,542},{20,23},{330,167},{20,23},{370,167},{20,23},{440,167},{20,23},
//			{370,167},{20,23},{330,167},{20,23},{294,542},{20,23},{247,167},{20,23},{294,355},
//			{20,23},{330,167},{20,23},{370,560},{20,250},{20,321},{20,188},{294,167},{20,23},
//			{247,167},{20,23},{294,542},{20,23},{247,167},{20,23},{294,355},{20,23},{330,167},
//			{20,23},{370,560},{20,250},{20,321},{20,188},{294,167},{20,23},{247,167},{20,23},
//			{294,542},{20,23},{247,167},{20,23},{294,355},{20,23},{330,167},{20,23},{294,560},
//			{20,250},{20,321},{20,188},{294,167},{20,23},{330,167},{20,23},{370,542},{20,23},
//			{330,167},{20,23},{370,542},{20,23},{330,167},{20,23},{370,542},{20,23},{330,167},
//			{20,23},{370,167},{20,23},{440,167},{20,23},{370,167},{20,23},{330,167},{20,23},
//			{294,542},{20,23},{247,167},{20,23},{294,355},{20,23},{330,167},{20,23},{370,560},
//			{20,250},{20,321},{20,188},{294,167},{20,23},{247,167},{20,23},{294,542},{20,23},
//			{247,167},{20,23},{294,355},{20,23},{330,167},{20,23},{370,560},{20,250},{20,321},
//			{20,188},{294,167},{20,23},{247,167},{20,23},{294,542},{20,23},{247,167},{20,23},
//			{294,355},{20,23},{330,167},{20,23},{294,560},{20,750},{20,188},{20,100},{392,1105},
//			{20,23},{466,1105},{20,23},{466,167},{20,23},{466,167},{20,23},{466,167},{20,23},
//			{587,355},{20,23},{466,167},{20,23},{466,167},{20,23},{466,167},{20,23},{466,167},
//			{20,23},{466,167},{20,23},{466,167},{20,23},{466,167},{20,23},{466,167},{20,23},
//			{466,167},{20,23},{466,167},{20,23},{466,167},{20,23},{392,542},{20,23},{587,167},
//			{20,23},{466,167},{20,23},{466,167},{20,23},{466,167},{20,23},{466,167},{20,23},
//			{466,167},{20,23},{466,167},{20,23},{466,167},{20,23},{466,167},{20,23},{466,167},
//			{20,23},{466,167},{20,23},{466,167},{20,23},{466,167},{20,23},{392,542},{20,23},
//			{392,167},{20,23},{587,167},{20,23},{466,167},{20,23},{466,167},{20,23},{466,167},
//			{20,23},{466,167},{20,23},{466,167},{20,23},{466,167},{20,23},{466,167},{20,23},
//			{466,355},{20,23},{466,355},{20,23},{587,355},{20,23},{698,355},{20,23},{784,1105},
//			{20,23},{698,1667},{20,23},{466,167},{20,23},{523,355},{20,23},{523,355},{20,23},
//			{466,355},{20,23},{587,1479},{20,23},{587,167},{20,23},{698,167},{20,23},{784,355},
//			{20,23},{880,355},{20,23},{784,355},{20,23},{698,355},{20,23},{587,355},{20,23},
//			{523,355},{20,23},{523,355},{20,23},{466,355},{20,23},{523,355},{20,23},{523,355},
//			{20,23},{587,355},{20,23},{466,1125},{20,100},{20,94},{523,167},{20,23},{587,167},
//			{20,23},{698,167},{20,23},{784,1105},{20,23},{698,1667},{20,23},{466,167},{20,23},
//			{523,355},{20,23},{523,355},{20,23},{466,355},{20,23},{587,1105},{20,23},{587,355},
//			{20,23},{698,355},{20,23},{784,355},{20,23},{932,355},{20,23},{1047,355},{20,23},
//			{1175,355},{20,23},{1047,355},{20,23},{932,355},{20,23},{784,355},{20,23},{932,355},
//			{20,23},{1047,355},{20,23},{1047,355},{20,23},{932,355},{20,23},{932,1105},{20,23},
//			{784,355},{20,23},{932,355},{20,23},{1047,355},{20,23},{1047,355},{20,23},{932,355},
//			{20,23},{932,1105},{20,23},{932,355},{20,23},{880,355},{20,23},{784,1105},{20,23},
//			{698,1105},{20,23},{932,355},{20,23},{880,355},{20,23},{784,542},{20,23},{880,167},
//			{20,23},{784,355},{20,23},{698,355},{20,23},{587,729},{20,23},{349,167},{20,23},
//			{392,167},{20,23},{466,167},{20,23},{523,167},{20,23},{587,542},{20,23},{523,167},
//			{20,23},{587,542},{20,23},{523,167},{20,23},{587,542},{20,23},{523,167},{20,23},
//			{587,167},{20,23},{698,167},{20,23},{587,167},{20,23},{523,167},{20,23},{466,542},
//			{20,23},{392,167},{20,23},{466,355},{20,23},{523,167},{20,23},{466,1310},{20,250},
//			{20,321},{370,542},{20,23},{330,167},{20,23},{370,542},{20,23},{330,167},{20,23},
//			{370,542},{20,23},{330,167},{20,23},{370,167},{20,23},{440,167},{20,23},{370,167},
//			{20,23},{330,167},{20,23},{294,542},{20,23},{247,167},{20,23},{294,355},{20,23},
//			{330,167},{20,23},{370,560},{20,250},{20,321},{20,188},{294,167},{20,23},{247,167},
//			{20,23},{294,542},{20,23},{247,167},{20,23},{294,355},{20,23},{330,167},{20,23},
//			{370,560},{20,250},{20,321},{20,188},{294,167},{20,23},{247,167},{20,23},{294,542},
//			{20,23},{247,167},{20,23},{294,355},{20,23},{330,167},{20,23},{294,938},{20,250},
//			{20,321},{20,188},{370,542},{20,23},{330,167},{20,23},{370,542},{20,23},{330,167},
//			{20,23},{370,542},{20,23},{330,167},{20,23},{370,167},{20,23},{440,167},{20,23},
//			{370,167},{20,23},{330,167},{20,23},{294,542},{20,23},{247,167},{20,23},{294,355},
//			{20,23},{330,167},{20,23},{370,560},{20,250},{20,321},{20,188},{294,167},{20,23},
//			{247,167},{20,23},{294,542},{20,23},{247,167},{20,23},{294,355},{20,23},{330,167},
//			{20,23},{370,560},{20,250},{20,321},{20,188},{294,167},{20,23},{247,167},{20,23},
//			{294,542},{20,23},{247,167},{20,23},{294,355},{20,23},{330,167},{20,23},{294,560},
//			{20,750},{20,100},{20,94},{294,1105},{20,23},{349,1105},{20,23},{466,167},{20,23},
//			{466,167},{20,23},{466,167},{20,23},{587,355},{20,23},{466,167},{20,23},{466,167},
//			{20,23},{466,167},{20,23},{466,167},{20,23},{466,167},{20,23},{466,167},{20,23},
//			{466,167},{20,23},{466,167},{20,23},{466,167},{20,23},{466,167},{20,23},{466,167},
//			{20,23},{392,542},{20,23},{587,167},{20,23},{466,167},{20,23},{466,167},{20,23},
//			{466,167},{20,23},{466,167},{20,23},{466,167},{20,23},{466,167},{20,23},{466,167},
//			{20,23},{466,167},{20,23},{466,167},{20,23},{466,167},{20,23},{466,167},{20,23},
//			{466,167},{20,23},{392,542},{20,23},{392,167},{20,23},{587,167},{20,23},{466,167},
//			{20,23},{466,167},{20,23},{466,167},{20,23},{466,167},{20,23},{466,167},{20,23},
//			{466,167},{20,23},{466,167},{20,23},{466,355},{20,23},{466,355},{20,23},{587,355},
//			{20,23},{698,355},{20,23},{784,1105},{20,23},{698,1105},{20,23},{466,355},{20,23},
//			{523,729},{20,23},{587,1125},{20,300},{20,83},{466,375},{20,750},{20,300},{20,83},
//			{784,355},{20,23},{784,355},{20,23},{784,167},{20,23},{784,542},{20,23},{698,355},
//			{20,23},{698,355},{20,23},{587,167},{20,23},{698,542},{20,23},{784,1125},{20,750},
//			{20,100},{20,94},{523,167},{20,23},{523,167},{20,23},{587,167},{20,23},{622,355},
//			{20,23},{1047,355},{20,23},{932,2229},{20,23},{1175,729},{20,23},{1047,729},{20,23},
//			{932,729},{20,23},{880,729},{20,23},{784,1479},{20,23},{880,1105},{20,23},{932,167},
//			{20,23},{1047,355},{20,23},{784,1310},{20,300},{20,83},{932,355},{20,23},{1175,355},
//			{20,23},{1397,355},{20,23},{1568,1105},{20,23},{1397,1667},{20,23},{932,167},{20,23},
//			{1047,355},{20,23},{1047,355},{20,23},{932,355},{20,23},{1175,1479},{20,23},
//			{1175,167},{20,23},{1397,167},{20,23},{1568,355},{20,23},{1760,355},{20,23},
//			{1568,355},{20,23},{1397,355},{20,23},{1175,355},{20,23},{1047,355},{20,23},
//			{1047,355},{20,23},{932,355},{20,23},{1047,355},{20,23},{1047,355},{20,23},
//			{1175,355},{20,23},{932,1125},{20,100},{20,94},{1047,167},{20,23},{1175,167},
//			{20,23},{1397,167},{20,23},{1568,1105},{20,23},{1397,1667},{20,23},{932,167},
//			{20,23},{1047,355},{20,23},{1047,355},{20,23},{932,355},{20,23},{1175,1105},{20,23},
//			{1175,355},{20,23},{1397,355},{20,23},{1568,355},{20,23},{1865,375},{20,750},{20,300},
//			{20,83},{1865,355},{20,23},{1568,355},{20,23},{1865,375},{20,250},{20,321},{20,188},
//			{1865,355},{20,23},{1865,1105},{20,23},{784,355},{20,23},{932,355},{20,23},{1047,355},
//			{20,23},{1047,355},{20,23},{932,355},{20,23},{932,1105},{20,23},{932,355},{20,23},
//			{880,355},{20,23},{784,1105},{20,23},{698,1105},{20,23},{932,355},{20,23},{880,355},
//			{20,23},{784,542},{20,23},{880,167},{20,23},{784,355},{20,23},{698,355},{20,23},
//			{587,729},{20,23},{349,167},{20,23},{392,167},{20,23},{466,167},{20,23},{523,167},
//			{20,23},{587,542},{20,23},{523,167},{20,23},{587,542},{20,23},{523,167},{20,23},
//			{587,542},{20,23},{523,167},{20,23},{587,167},{20,23},{698,167},{20,23},{587,167},
//			{20,23},{523,167},{20,23},{466,542},{20,23},{392,167},{20,23},{466,355},{20,23},
			{523,167},{20,23},{466,917},{20,23},{932,355},{20,23},{880,355},{20,23},{784,1105},
			{20,23},{698,1105},{20,23},{932,355},{20,23},{880,355},{20,23},{784,542},{20,23},
			{880,167},{20,23},{784,355},{20,23},{698,355},{20,23},{587,729},{20,23},{349,167},
			{20,23},{392,167},{20,23},{466,167},{20,23},{523,167},{20,23},{587,542},{20,23},
			{523,167},{20,23},{587,542},{20,23},{523,167},{20,23},{587,542},{20,23},{523,167},
			{20,23},{587,167},{20,23},{698,167},{20,23},{587,167},{20,23},{523,167},{20,23},
			{466,542},{20,23},{392,167},{20,23},{466,355},{20,23},{523,167},{20,23},{466,3188}
    };

    int length = sizeof(melody) / sizeof(Note);

    for (int i = 0; i < length; i++) {
        if (melody[i].frequency == 20) {
            Buzzer_SetVolume(buzzer, 0);

        } else {
            Buzzer_SetVolume(buzzer, 36);

            Buzzer_SetFrequency(buzzer, melody[i].frequency);
        }
        HAL_Delay(melody[i].duration);
    }
    Buzzer_SetVolume(buzzer, 0);
}
